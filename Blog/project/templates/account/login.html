{% extends 'layout/layout.html' %}

{% block content %}
    <main>
        <section>
            <div class="container-fluid">
                <div class="col-md-6 mx-auto">
                    <!--Modal: Login & Register tabs-->
                    <div class="modal-dialog cascading-modal" role="document">
                        <!--Content-->
                        <div class="modal-content">

                            <!--Modal cascading tabs-->
                            <div class="modal-c-tabs">

                                <!-- Nav tabs -->
                                <ul class="nav nav-tabs tabs-2 light-blue darken-3" role="tablist">
                                    <li class="nav-item waves-effect waves-light">
                                        <a class="nav-link active" data-toggle="tab" href="#panel1" role="tab">
                                            <i class="fa fa-user mr-1"></i> Login</a>
                                    </li>
                                    <li class="nav-item waves-effect waves-light">
                                        <a class="nav-link" data-toggle="tab" href="#panel2" role="tab">
                                            <i class="fa fa-user-plus mr-1"></i> Register</a>
                                    </li>
                                </ul>

                                <!-- Tab panels -->
                                <div class="tab-content">
                                    <!--Panel 1-->
                                    <div class="tab-pane fade in show active" id="panel1" role="tabpanel">
                                        <form action='{{ url_for('login') }}' , method="post">
                                            <!--Body-->
                                            <div class="modal-body mb-1">
                                                <div class="md-form form-sm">
                                                    <i class="fa fa-user prefix"></i>
                                                    <input type="text" id="txtLUsername" name="username" required
                                                           class="form-control">
                                                    <label for="txtLUsername">Your username</label>
                                                </div>

                                                <div class="md-form form-sm">
                                                    <i class="fa fa-lock prefix"></i>
                                                    <input type="password" id="txtLPassword" name="password" required
                                                           class="form-control">
                                                    <label for="txtLPassword">Your password</label>
                                                </div>
                                                <p class="text-danger text-center font-bold">{{ error_message }}</p>
                                                <div class="text-center mt-2">
                                                    <button class="btn btn-info waves-effect waves-light" type="submit">
                                                        Log in
                                                        <i class="fa fa-sign-in ml-1"></i>
                                                    </button>

                                                </div>
                                                <div class="text-center mt-2">

                                                    <fb:login-button scope="public_profile,email" data-size="large"
                                                                     data-button-type="login_with"
                                                                     onlogin="checkLoginFB();">Login With Facebook
                                                    </fb:login-button>
                                                </div>
                                            </div>
                                        </form>
                                        <!--Footer-->
                                        <div class="modal-footer display-footer">
                                            <div class="options text-center text-md-right mt-1">
                                                <p>
                                                    <a href="#" class="blue-text" data-toggle="modal"
                                                       data-target="#modalForgetPasswordForm">Forgot Password?</a>
                                                </p>

                                            </div>

                                        </div>


                                    </div>
                                    <!--/.Panel 1-->

                                    <!--Panel 2-->
                                    <div class="tab-pane fade" id="panel2" role="tabpanel">
                                        <form action={{ url_for('register') }}, method="post">
                                            <!--Body-->
                                            <div class="modal-body">
                                                <div class="md-form form-sm">
                                                    <i class="fa fa-user prefix"></i>
                                                    <input type="text" id="txtUsername" name="username"
                                                           class="form-control" required>
                                                    <label for="txtUsername">Your username</label>
                                                    <p id="errorUsername"
                                                       class="text-danger text-center small font-bold"></p>
                                                </div>
                                                <div class="md-form form-sm">
                                                    <i class="fa fa-envelope prefix"></i>
                                                    <input type="email" id="txtEmail" name="email" class="form-control"
                                                           required>
                                                    <label for="txtEmail">Your email</label>
                                                    <p id="errorEmail"
                                                       class="text-danger text-center small font-bold"></p>
                                                </div>

                                                <div class="md-form form-sm">
                                                    <i class="fa fa-lock prefix"></i>
                                                    <input type="password" id="txtPassword" name="password"
                                                           class="form-control" required>
                                                    <label for="txtPassword">Your password</label>
                                                </div>

                                                <div class="md-form form-sm">
                                                    <i class="fa fa-lock prefix"></i>
                                                    <input type="password" id="txtRepeatpass" name="repassword"
                                                           class="form-control" required>
                                                    <label for="txtRepeatpass">Repeat password</label>
                                                    <p id="errorRePass"
                                                       class="text-danger text-center small font-bold"></p>
                                                </div>

                                                <div class="text-center form-sm mt-2">
                                                    <button id="btnSubmitRegister"
                                                            class="btn btn-info waves-effect waves-light"> Sign up
                                                        <i class="fa fa-sign-in ml-1"></i>
                                                    </button>
                                                </div>

                                            </div>
                                        </form>
                                        <!--Footer-->
                                        <div class="modal-footer">
                                            <div class="options text-right">
                                                <p class="pt-1">Already have an account?
                                                    <a class="blue-text" id="switchTabLogin">Log In</a>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/.Panel 2-->
                                </div>

                            </div>
                        </div>
                        <!--/.Content-->
                    </div>
                    <!--/Modal: Login & Register tabs-->

                </div>
            </div>
        </section>
    </main>
    <div class="spinner"></div>
    <div class="modal fade" id="modalForgetPasswordForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Forgot Password</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">
                    <div class="md-form">
                        <i class="fa fa-envelope prefix grey-text"></i>
                        <input type="email" id="emailForgot" class="form-control validate">
                        <label data-error="wrong" data-success="right" for="defaultForm-email">Your email</label>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button class="btn btn-default" id="btnGetNewPassword">Get New Password</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js_footer %}
    <script>
        $(document).ready(function () {
            $('#txtUsername').focusout(function () {
                    var username = $('#txtUsername').val();
                    $.ajax({
                        url: '{{ url_for('check_username') }}',
                        type: 'POST',
                        data: {'username': username},
                        success: function (response) {
                            var data = JSON.parse(response);
                            if (data.code === 201) {
                                $('#errorUsername').text(data.message);
                            }
                        }
                    });
                }
            );

            $('#txtEmail').focusout(function () {
                    var email = $('#txtEmail').val();
                    $.ajax({
                        url: '{{ url_for('check_email') }}',
                        type: 'POST',
                        data: {'email': email},
                        success: function (response) {
                            var data = JSON.parse(response);
                            if (data.code === 201) {
                                $('#errorEmail').text(data.message);
                            }
                        }
                    });
                }
            );
            $('#txtRepeatpass').focusout(function () {
                    var pass = $('#txtPassword').val();
                    var repass = $('#txtRepeatpass').val();
                    console.log(pass);
                    console.log(repass);
                    if (pass !== repass) {
                        $('#errorRePass').text("Confirm password does not match the password.");
                    }
                }
            );

            $('#txtUsername').focusin(function () {
                    $('#errorUsername').text("");
                }
            );
            $('#txtEmail').focusin(function () {
                $('#errorEmail').text("");
            });
            $('#txtRepeatpass').focusin(function () {
                $('#errorRePass').text("");
            });

            $('#btnSubmitRegister').click(function (e) {
                e.preventDefault();
                var uname = $('#txtUsername').val();
                var email = $('#txtEmail').val();
                var pass = $('#txtPassword').val();
                $('.spinner').show();
                $.ajax({
                    url: '{{ url_for('register') }}',
                    type: 'POST',
                    data: {'username': uname, 'email': email, 'password': pass},
                    success: function (response) {
                        var data = JSON.parse(response);
                        if (data.code === 201) {
                            $('.spinner').hide();
                            show_stack_bar_top('error', 'Oh no!', data.message);
                        }
                        else if (data.code === 200) {
                            $('.spinner').hide();
                            $('.nav-tabs a[href="#panel1"]').tab('show');
                            show_stack_bar_top('success', 'Congratulation!', data.message);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                        $('.spinner').hide();
                        show_stack_bar_top('error', 'Oh no!', jqXHR.status + '(' + errorThrown + ')');
                    }
                });
            });

            $('#switchTabLogin').click(function (e) {
                e.preventDefault();
                $('.nav-tabs a[href="#panel1"]').tab('show');
            });

            $('#btnGetNewPassword').click(function (e) {
                e.preventDefault();
                $('#modalForgetPasswordForm').modal('toggle');
                var email = $('#emailForgot').val();
                $('.spinner').show();
                $.ajax({
                    url: '{{ url_for('forgetpassword') }}',
                    type: 'post',
                    data: {'email': email},
                    success: function (response) {
                        var data = JSON.parse(response);
                        if (data.code === 201) {
                            $('.spinner').hide();
                            show_stack_bar_top('error', 'Oh no!', data.message);
                        }
                        else if (data.code === 200) {
                            $('.spinner').hide();
                            toastr.options = {
                                "closeButton": false,
                                "debug": false,
                                "newestOnTop": false,
                                "progressBar": false,
                                "positionClass": "toast-top-full-width",
                                "preventDuplicates": false,
                                "onclick": null,
                                "showDuration": 300,
                                "hideDuration": 1000,
                                "timeOut": 5000,
                                "extendedTimeOut": 1000,
                                "showEasing": "swing",
                                "hideEasing": "linear",
                                "showMethod": "fadeIn",
                                "hideMethod": "fadeOut"
                            };
                            toastr["success"](data.message);
                            {#                            show_stack_bar_top('success', 'Success!', data.message);#}
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                        $('.spinner').hide();
                        show_stack_bar_top('error', 'Oh no!', jqXHR.status + '(' + errorThrown + ')');
                    }
                });
            });
        });
    </script>

{% endblock %}